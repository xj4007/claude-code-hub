# 统一客户端标识功能设计文档

## 功能概述

为 Claude/Claude-Auth 类型的供应商添加"使用统一的客户端标识"功能。启用后，在转发请求时会将 `metadata.user_id` 中的客户端标识部分替换为配置的统一值，使所有请求看起来来自同一个客户端，减少特征。

## 参考实现

- **前端参考**: `claude-relay-service/web/admin-spa/src/components/accounts/AccountForm.vue` (1731-1781行)
- **后端参考**: `claude-relay-service/src/services/claudeConsoleRelayService.js` (1713-1728行)

## user_id 格式解析

Claude Code 的 `metadata.user_id` 格式为:
```
user_{64位十六进制客户端标识}_account__session_{uuid}
```

示例:
```
user_a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456_account__session_550e8400-e29b-41d4-a716-446655440000
```

替换逻辑:
- 只替换 `user_` 后面的 64 位十六进制部分（客户端标识）
- 保留 `_account__session_{uuid}` 部分用于粘性会话

## 数据库迁移流程说明

本项目使用 Drizzle ORM 进行数据库管理，迁移流程如下：

1. **修改 Schema**: 编辑 `src/drizzle/schema.ts` 添加新字段
2. **生成迁移**: 运行 `bun run db:generate`，Drizzle Kit 会自动分析 schema 变更，在 `drizzle/` 目录生成 SQL 迁移文件
3. **执行迁移**:
   - **本地开发**: 运行 `bun run db:migrate` 手动执行
   - **Docker Compose 部署**: 容器启动时自动执行（`AUTO_MIGRATE=true`）

⚠️ **重要**:
- 不要手动创建迁移文件，始终使用 `db:generate` 自动生成
- **Docker 部署前必须先运行 `bun run db:generate`**，否则新的迁移文件不会被打包到镜像中

### Docker Compose 部署流程

```bash
# 1. 修改代码后生成迁移文件（必需！）
bun run db:generate

# 2. 提交到 Git（可选，但推荐）
git add drizzle/
git commit -m "feat: add unified client id"

# 3. 重新构建并启动容器
docker compose down
docker compose up -d --build

# 容器启动时会自动执行 drizzle/ 目录中的所有迁移文件
```

## 需要修改的文件清单

### 1. 数据库层

#### 1.1 `src/drizzle/schema.ts`

在 `providers` 表中添加两个新字段:

```typescript
// 在 providers 表定义中添加（约在 mcpPassthroughUrl 字段后）

// 统一客户端标识配置（仅 claude/claude-auth 类型有效）
// 启用后将替换请求中的 user_id 客户端部分
useUnifiedClientId: boolean('use_unified_client_id').default(false),
// 64位十六进制字符串，用于替换 user_id 中的客户端标识
unifiedClientId: varchar('unified_client_id', { length: 64 }),
```

#### 1.2 生成和执行数据库迁移

**步骤 1**: 修改完 `schema.ts` 后，运行以下命令生成迁移文件:

```bash
bun run db:generate
```

这会在 `drizzle/` 目录下自动生成新的迁移文件，类似:
```
drizzle/0028_xxxx_xxxx.sql
```

生成的 SQL 内容应该类似:
```sql
ALTER TABLE "providers" ADD COLUMN "use_unified_client_id" boolean DEFAULT false;
ALTER TABLE "providers" ADD COLUMN "unified_client_id" varchar(64);
```

**步骤 2**: 执行迁移到数据库:

```bash
bun run db:migrate
```

或者，如果只是本地开发测试，也可以使用 push 命令直接同步 schema（不生成迁移文件）:

```bash
bun run db:push
```

⚠️ **注意**: 生产环境建议使用 `db:generate` + `db:migrate` 的方式，保留迁移历史记录。

### 2. 类型定义

#### 2.1 `src/types/provider.ts`

在 `Provider` 接口中添加（约在 `mcpPassthroughUrl` 后）:

```typescript
// 统一客户端标识配置（仅 claude/claude-auth 类型有效）
useUnifiedClientId: boolean;
unifiedClientId: string | null;
```

在 `ProviderDisplay` 接口中添加:

```typescript
// 统一客户端标识配置
useUnifiedClientId: boolean;
unifiedClientId: string | null;
```

在 `CreateProviderData` 接口中添加:

```typescript
use_unified_client_id?: boolean;
unified_client_id?: string | null;
```

在 `UpdateProviderData` 接口中添加:

```typescript
use_unified_client_id?: boolean;
unified_client_id?: string | null;
```

### 3. 前端表单

#### 3.1 `src/app/[locale]/settings/providers/_components/forms/provider-form.tsx`

##### 3.1.1 添加状态变量（约在 `mcpPassthroughUrl` 状态后）:

```typescript
// 统一客户端标识配置
const [useUnifiedClientId, setUseUnifiedClientId] = useState<boolean>(
  sourceProvider?.useUnifiedClientId ?? false
);
const [unifiedClientId, setUnifiedClientId] = useState<string>(
  sourceProvider?.unifiedClientId ?? ""
);
```

##### 3.1.2 添加生成客户端标识的辅助函数:

```typescript
// 生成64位十六进制客户端标识
const generateUnifiedClientId = () => {
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');
};
```

##### 3.1.3 在 `routing` Collapsible 区域中添加 UI（在 `joinClaudePool` 开关后，仅当 providerType 为 "claude" 或 "claude-auth" 时显示）:

```tsx
{/* 统一客户端标识配置 - 仅 Claude/Claude-Auth 供应商显示 */}
{(providerType === "claude" || providerType === "claude-auth") && (
  <div className="space-y-2">
    <div className="flex items-center justify-between">
      <div className="space-y-0.5">
        <Label htmlFor={isEdit ? "edit-use-unified-client-id" : "use-unified-client-id"}>
          {t("sections.routing.unifiedClientId.label")}
        </Label>
        <p className="text-xs text-muted-foreground">
          {t("sections.routing.unifiedClientId.desc")}
        </p>
      </div>
      <Switch
        id={isEdit ? "edit-use-unified-client-id" : "use-unified-client-id"}
        checked={useUnifiedClientId}
        onCheckedChange={(checked) => {
          setUseUnifiedClientId(checked);
          // 首次启用时自动生成 ID
          if (checked && !unifiedClientId) {
            setUnifiedClientId(generateUnifiedClientId());
          }
        }}
        disabled={isPending}
      />
    </div>

    {useUnifiedClientId && (
      <div className="rounded-lg border border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-800/50">
        <div className="mb-2 flex items-center justify-between">
          <span className="text-xs font-medium text-gray-600 dark:text-gray-400">
            {t("sections.routing.unifiedClientId.idLabel")}
          </span>
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => setUnifiedClientId(generateUnifiedClientId())}
            disabled={isPending}
          >
            {t("sections.routing.unifiedClientId.regenerate")}
          </Button>
        </div>
        <code className="block w-full select-all break-all rounded bg-gray-100 px-3 py-2 font-mono text-xs text-gray-700 dark:bg-gray-900 dark:text-gray-300">
          {unifiedClientId}
        </code>
        <p className="mt-2 text-xs text-muted-foreground">
          {t("sections.routing.unifiedClientId.help")}
        </p>
      </div>
    )}
  </div>
)}
```

##### 3.1.4 更新 `handleSubmit` 函数

在 `updateData` 和 `addProvider` 调用中添加新字段:

```typescript
// 在 updateData 对象中添加
use_unified_client_id: useUnifiedClientId,
unified_client_id: useUnifiedClientId ? (unifiedClientId || null) : null,

// 在 addProvider 参数中添加
use_unified_client_id: useUnifiedClientId,
unified_client_id: useUnifiedClientId ? (unifiedClientId || null) : null,
```

##### 3.1.5 更新表单重置逻辑（新增时重置）:

```typescript
setUseUnifiedClientId(false);
setUnifiedClientId("");
```

### 4. 国际化文件

#### 4.1 `src/locales/zh-CN/settings.json`

在 `providers.form.sections.routing` 中添加:

```json
"unifiedClientId": {
  "label": "使用统一的客户端标识",
  "desc": "启用后将使用固定的客户端标识，使所有请求看起来来自同一个客户端",
  "idLabel": "客户端标识 ID",
  "regenerate": "重新生成",
  "help": "此ID将替换请求中的 user_id 客户端部分，保留 session 部分用于粘性会话"
}
```

#### 4.2 `src/locales/en/settings.json`

在 `providers.form.sections.routing` 中添加:

```json
"unifiedClientId": {
  "label": "Use Unified Client ID",
  "desc": "When enabled, uses a fixed client identifier so all requests appear from the same client",
  "idLabel": "Client ID",
  "regenerate": "Regenerate",
  "help": "This ID replaces the user_id client part, keeping the session part for sticky sessions"
}
```

### 5. Server Actions

#### 5.1 `src/actions/providers.ts`

更新 `addProvider` 函数的参数类型和处理逻辑，添加新字段。

更新 `editProvider` 函数的参数类型和处理逻辑，添加新字段。

### 6. Repository

#### 6.1 `src/repository/provider.ts`

确保 `findAllProviders`、`findProviderById` 等方法返回的数据包含新字段。

确保 `createProvider`、`updateProvider` 方法正确处理新字段。

### 7. 核心逻辑 - 请求转发时替换 user_id

#### 7.1 `src/app/v1/_lib/proxy/forwarder.ts`

在 `doForward` 方法中，标准处理（非 Gemini）路径里，在格式转换之后、构建请求体之前，添加 user_id 替换逻辑:

```typescript
// 在约 900 行附近，构建 requestBody 之前添加

// 统一客户端标识处理（仅 claude/claude-auth 类型）
if (
  (provider.providerType === "claude" || provider.providerType === "claude-auth") &&
  provider.useUnifiedClientId &&
  provider.unifiedClientId
) {
  ProxyForwarder.replaceClientId(session.request.message, provider.unifiedClientId);
}
```

添加静态辅助方法:

```typescript
/**
 * 替换请求中的客户端标识
 *
 * user_id 格式: user_{64位十六进制}_account__session_{uuid}
 * 只替换第一个下划线后到 _account 之前的部分（客户端标识）
 * 保留 _account__session_{uuid} 部分用于粘性会话
 */
private static replaceClientId(
  body: Record<string, unknown>,
  unifiedClientId: string
): void {
  if (!body || !body.metadata) {
    return;
  }

  const metadata = body.metadata as Record<string, unknown>;
  if (!metadata.user_id || typeof metadata.user_id !== "string") {
    return;
  }

  const userId = metadata.user_id;
  // user_id 格式: user_{64位十六进制}_account__session_{uuid}
  // 只替换第一个下划线后到 _account 之前的部分
  const match = userId.match(/^user_[a-f0-9]{64}(_account__session_[a-f0-9-]{36})$/);

  if (match && match[1]) {
    // 替换客户端标识部分
    metadata.user_id = `user_${unifiedClientId}${match[1]}`;

    logger.info("[ProxyForwarder] Replaced client ID with unified ID", {
      original: userId.substring(0, 20) + "...", // 只记录前20位
      unified: (metadata.user_id as string).substring(0, 20) + "...",
    });
  }
}
```

### 8. 验证步骤

确认以下文件已正确更新后，按顺序执行验证:

1. **生成数据库迁移**:
   ```bash
   bun run db:generate
   ```
   检查 `drizzle/` 目录下是否生成了新的迁移文件

2. **执行数据库迁移**:
   ```bash
   bun run db:migrate
   ```
   确保迁移成功应用到数据库

3. **TypeScript 编译**:
   ```bash
   bun run typecheck
   ```
   确保类型正确

4. **前端构建**:
   ```bash
   bun run build
   ```
   确保构建成功

5. **功能测试**:
   - 启动应用: `bun run dev`
   - 创建 Claude 类型供应商，启用统一客户端标识
   - 发送测试请求，查看日志确认 user_id 被正确替换
   - 验证 session 粘性功能仍然正常工作

## 修改文件汇总

| 文件路径 | 修改类型 | 说明 |
|---------|---------|------|
| `src/drizzle/schema.ts` | 修改 | 添加 `use_unified_client_id` 和 `unified_client_id` 字段 |
| `drizzle/0028_*.sql` | 自动生成 | 运行 `bun run db:generate` 自动生成迁移脚本 |
| `src/types/provider.ts` | 修改 | 添加类型定义 |
| `src/app/[locale]/settings/providers/_components/forms/provider-form.tsx` | 修改 | 添加 UI 控件 |
| `src/locales/zh-CN/settings.json` | 修改 | 添加中文翻译 |
| `src/locales/en/settings.json` | 修改 | 添加英文翻译 |
| `src/actions/providers.ts` | 修改 | 更新 Server Actions |
| `src/repository/provider.ts` | 修改 | 更新 Repository |
| `src/app/v1/_lib/proxy/forwarder.ts` | 修改 | 添加 user_id 替换逻辑 |

## 注意事项

1. **安全性**: 客户端标识 ID 应该是随机生成的 64 位十六进制字符串
2. **兼容性**: 只有当 user_id 格式匹配 `user_{64位十六进制}_account__session_{uuid}` 时才会替换
3. **日志**: 替换操作会记录日志，但不会暴露完整的 user_id（只记录前 20 位）
4. **会话粘性**: 替换后仍保留 session 部分，不影响会话粘性功能
5. **条件生效**: 只有当供应商类型为 `claude` 或 `claude-auth` 且启用了统一客户端标识时才会生效
