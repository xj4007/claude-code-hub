# 供应商配置页按钮（开关）渲染说明

本文档说明：供应商配置页面中的三个按钮（开关）如何渲染、如何提交，以及涉及的修改文件。

## 功能范围
供应商配置页（新版表单）路由配置区域新增三个开关：
1. 统一客户端 ID（Unified Client ID）
2. 模拟缓存（Simulate Cache）
3. 补充提示词注入（Supplementary Prompt Injection）

> 仅当供应商类型为 Claude / Claude-Auth 时显示。

## 前端渲染逻辑
### 1) 状态来源与初始化
- 入口：`ProviderFormProvider` 使用 `createInitialState` 构建表单初始状态。
- 当编辑供应商时，从 `provider` 读取已有值；创建时从 `cloneProvider` 或默认值初始化。

涉及文件：
- `src/app/[locale]/settings/providers/_components/forms/provider-form/provider-form-context.tsx`

初始化字段（routing 下）：
- `useUnifiedClientId`: boolean
- `unifiedClientId`: string
- `simulateCacheEnabled`: boolean
- `supplementaryPromptEnabled`: boolean

### 2) Reducer 与状态更新
- 通过 reducer 管理开关与文本变化。
- 新增的 action 类型：
  - `SET_USE_UNIFIED_CLIENT_ID`
  - `SET_UNIFIED_CLIENT_ID`
  - `SET_SIMULATE_CACHE_ENABLED`
  - `SET_SUPPLEMENTARY_PROMPT_ENABLED`

涉及文件：
- `src/app/[locale]/settings/providers/_components/forms/provider-form/provider-form-types.ts`
- `src/app/[locale]/settings/providers/_components/forms/provider-form/provider-form-context.tsx`

### 3) 组件渲染条件
- 路由配置区 `RoutingSection` 中仅当：
  - `providerType === "claude"` 或 `providerType === "claude-auth"`
  时显示这三个开关。

涉及文件：
- `src/app/[locale]/settings/providers/_components/forms/provider-form/sections/routing-section.tsx`

### 4) 统一客户端 ID 的生成逻辑
- 点击开关开启时，如当前 ID 为空，会自动生成 64 位十六进制字符串。
- 提供“重新生成”按钮，随时生成新 ID。

涉及文件：
- `src/app/[locale]/settings/providers/_components/forms/provider-form/sections/routing-section.tsx`

生成方式（前端）：
- `crypto.getRandomValues` 生成 32 字节 → 转为 64 位 hex 字符串

## 提交与保存逻辑
- 提交时将开关值写入表单请求体：
  - `use_unified_client_id`
  - `unified_client_id`
  - `simulate_cache_enabled`
  - `supplementary_prompt_enabled`
- 其中 `unified_client_id` 仅在开关启用时提交，否则写入 `null`。

涉及文件：
- `src/app/[locale]/settings/providers/_components/forms/provider-form/index.tsx`

## i18n 文案
新增 unifiedClientId 的多语言文案，避免出现 missing key：
- `messages/en/settings/providers/form/sections.json`
- `messages/zh-TW/settings/providers/form/sections.json`
- `messages/ja/settings/providers/form/sections.json`
- `messages/ru/settings/providers/form/sections.json`

> zh-CN 先前已存在 unifiedClientId 文案，无需新增。

## 涉及修改文件清单
- `src/app/[locale]/settings/providers/_components/forms/provider-form/provider-form-types.ts`
- `src/app/[locale]/settings/providers/_components/forms/provider-form/provider-form-context.tsx`
- `src/app/[locale]/settings/providers/_components/forms/provider-form/index.tsx`
- `src/app/[locale]/settings/providers/_components/forms/provider-form/sections/routing-section.tsx`
- `messages/en/settings/providers/form/sections.json`
- `messages/zh-TW/settings/providers/form/sections.json`
- `messages/ja/settings/providers/form/sections.json`
- `messages/ru/settings/providers/form/sections.json`

## 备注
旧版表单 `provider-form.legacy.tsx` 已包含三个开关，新版表单合并后缺失，本次为同步回填。
